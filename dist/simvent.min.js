"use strict";var _createClass=function(){function e(t,i){for(var s=0;s<i.length;s++){var e=i[s];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function _possibleConstructorReturn(t,i){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!i||"object"!=typeof i&&"function"!=typeof i?t:i}function _inherits(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Super expression must either be null or a function, not "+typeof i);t.prototype=Object.create(i&&i.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),i&&(Object.setPrototypeOf?Object.setPrototypeOf(t,i):t.__proto__=i)}function _classCallCheck(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}var sv={translate:function(i,t,s){try{var e=dict[i][t][s]}catch(t){console.log("Was unable to translate "+i)}finally{return e}},log:function(t,i){return{time:i.time,Flung:t.flow,Palv:t.Palv,Pel:t.Pel,Pmus:t.Pmus,Vabs:t.Vabs,Vti:t.Vti,Vte:t.Vte,Vt:t.Vt,Vtmax:t.Vtmax,PCO2:t.PCO2,SCO2:t.SCO2,VCO2:t.VtCO2,Pao:i.Pao,Fip:i.Fip,Fop:i.Fop,stateP:i.stateP,Pcirc:i.Pcirc,Fmax:i.Fmax,Fstop:i.Fstop}},logPerc:function(t,i){return{time:i.time,Vtip:t.Vtip,Vtep:t.Vtep}},sygY:function(t,i,s,e,n){return i+(s-i)/(1+Math.exp(-(t-e)/n))},sygX:function(t,i,s,e,n){return e-n*Math.log((s-i)/(t-i)-1)},avg:function(t,i,s){for(var e=0;e<t.length-(s-1);e++){for(var n=e,a=t[n][i],o=n+1;o<n+s;o++)a+=t[o][i];t[n][i]=a/s}},defaultsTable:function(t){var i=document.scripts[document.scripts.length-1].parentNode,s=document.createElement("table");i.appendChild(s);var e=document.createElement("tr");(r=document.createElement("th")).textContent="Parameter",e.appendChild(r),(h=document.createElement("th")).textContent="Default",e.appendChild(h);var n=document.createElement("th");for(var a in n.textContent="Unit",e.appendChild(n),s.appendChild(e),t){var o=t[a];if(1!=o.calculated){var r,h;e=document.createElement("tr");(r=document.createElement("td")).textContent=a,e.appendChild(r),(h=document.createElement("td")).textContent=this[a],e.appendChild(h),(n=document.createElement("td")).textContent=o.unit,e.appendChild(n),s.appendChild(e)}}},download:function(t){var i="object"!=(void 0===t?"undefined":_typeof(t))?JSON.parse(t):t,s="",e="";for(var n in i[0])""!=e&&(e+="\t "),e+=n;s+=e+"\r\n";for(var a=0;a<i.length;a++){e="";for(var n in i[a])""!=e&&(e+="\t "),e+=i[a][n];s+=e+"\r\n"}var o=document.createElement("a");o.download="simvent.dat",o.href="data:text/tsv;charset=utf-8,"+escape(s),document.body.appendChild(o),setTimeout(function(){o.click(),document.body.removeChild(o)},66)}};sv.Lung=function(){function t(){_classCallCheck(this,t),this.defaults={Tsampl:.001,Raw:5,Vdaw:.1,PiCO2:0,PACO2:35,Slope2:.003,Slope3:5,Vti:0,Vte:0,Vtmax:0,PCO2:0,Vabs:0},this.parseDefaults()}return _createClass(t,[{key:"parseDefaults",value:function(){for(var t in this.defaults)this[t]=this.defaults[t]}},{key:"appliquer_pression",value:function(t,i){for(var s=0;s<i;){var e=(t-this.Palv)/this.Raw;this.appliquer_debit(e,this.Tsampl),s+=this.Tsampl}}},{key:"appliquer_debit",value:function(t,i){if(isNaN(t))throw"sv.SimpleLung.appliquer_debit: NaN value passed as flow";this.flow=t;var s=this.flow*i;this.Vabs+=s,0<this.flow?(this.Vti+=s,this.Vtmax=this.Vti,this.PCO2=0,this.Vte=0,this.VtCO2=0):(this.Vti=0,this.Vte-=s,this.updateCO2(),this.VtCO2+=this.SCO2*-s),this.time+=i}},{key:"updateCO2",value:function(){var t=sv.sygY(this.Vte,this.PiCO2,this.PplCO2,this.Vdaw,this.Slope2);this.Vte>this.Vdaw&&(t+=this.Slope3*(this.Vte-this.Vdaw)),this.PCO2=t}},{key:"complianceCurve",value:function(){var t=(new sv.PVCurve).ventilate(this).timeData,i="svg"+document.querySelectorAll("svg").length;function s(t){return t.Pel}function e(t){return t.Vabs}document.write("<svg id='"+i+"'></svg>");var n=new gs.graph("#"+i);n.setscale(t,s,e),n.tracer(t,s,e),n.setidx("Elastic recoil pressure (cmH₂O)"),n.setidy("Volume (l)")}},{key:"defaultsTable",value:function(){sv.defaultsTable.call(this,this.mechParams)}},{key:"Palv",get:function(){return this.Pel-this.Pmus}},{key:"Vt",get:function(){return this.Vtmax-this.Vte}},{key:"SCO2",get:function(){return this.PCO2/713}},{key:"VcAlv",get:function(){return this.Vtmax-this.Vdaw}},{key:"PplCO2",get:function(){return this.PACO2-this.Slope3*(this.VcAlv/2)}}]),t}(),sv.SimpleLung=function(t){function s(t){_classCallCheck(this,s);var i=_possibleConstructorReturn(this,(s.__proto__||Object.getPrototypeOf(s)).call(this));return i.defaults={Crs:50,Pmus:0,Vfrc:2.5},i.parseDefaults(),i.Vabs=i.Vfrc,i.mechParams={Crs:{unit:"ml/cmH₂O"},Raw:{unit:"cmH₂O/l/s"}},i}return _inherits(s,sv.Lung),_createClass(s,[{key:"Pel",get:function(){return 1e3*(this.Vabs-this.Vfrc)/this.Crs}}]),s}(),sv.SptLung=function(t){function i(){_classCallCheck(this,i);var t=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return t.defaults={Crs:50,Fspt:14,Ti:1,Pmax:6.5,Vabs:0,time:0},t.parseDefaults(),t.mechParams={Crs:{unit:"ml/cmH₂O"},Raw:{unit:"cmH₂O/l/s"},Fspt:{unit:"/min."},Ti:{unit:"sec."},Pmax:{unit:"cmH₂O"}},t}return _inherits(i,sv.Lung),_createClass(i,[{key:"Pmus",get:function(){var t=this.time%(60/this.Fspt);return t<this.Ti&&0<this.Fspt?.5*this.Pmax*(1+Math.sin(2*Math.PI*(t/this.Ti)-Math.PI/2)):0}},{key:"Pel",get:function(){return 1e3*this.Vabs/this.Crs}}]),i}(),sv.SygLung=function(t){function i(){_classCallCheck(this,i);var t=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return t.defaults={Vmax:4,Vmin:0,Pid:5,Kid:20,Pmus:0},t.parseDefaults(),t.mechParams={Vmax:{unit:"l"},Vmin:{unit:"l"},Pid:{unit:"cmH₂O"},Kid:{unit:"cmH₂O"},Raw:{unit:"cmH₂O/l/s"}},t.flow=0,t.Vabs=t.volume(0),t}return _inherits(i,sv.Lung),_createClass(i,[{key:"volume",value:function(t){return sv.sygY(t,this.Vmin,this.Vmax,this.Pid,this.Kid)}},{key:"Pel",get:function(){return sv.sygX(this.Vabs,this.Vmin,this.Vmax,this.Pid,this.Kid)}}]),i}(),sv.RLung=function(t){function i(){_classCallCheck(this,i);var t=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return t.defaults={Vmax:4,Vmin:0,Pid:20,Kid:20,Phister:20,flow:0,lastFlow:0,Pmus:0,Vtmax:0,lastPel:0},t.parseDefaults(),t.VmaxExp=t.Vmax,t.VminInsp=t.Vmin,t.Vabs=t.volume(0),console.log("Palv = "+t.Palv),console.log("Palv = "+t.Palv),t.fitInsp(),t.fitExp(),t.appliquer_pression(1,3),t.appliquer_pression(-1,3),t.appliquer_pression(1,3),t.appliquer_pression(-1,3),console.log("Palv = "+t.Palv),console.log("VminInsp = "+t.VminInsp),console.log("VmaxExp = "+t.VmaxExp),t.mechParams={Vmax:{unit:"l"},Vmin:{unit:"l"},PidInsp:{unit:"cmH₂O"},PidExp:{unit:"cmH₂O"},Kid:{unit:"cmH₂O"},Raw:{unit:"cmH₂O/l/s"}},t}return _inherits(i,sv.Lung),_createClass(i,[{key:"volume",value:function(t){return sv.sygY(t,this.Vmin,this.Vmax,this.Pid,this.Kid)}},{key:"fitInsp",value:function(){console.log("fitInsp");var t=1+Math.pow(Math.E,-(this.lastPel-this.PidInsp)/this.Kid);this.VminInsp=(t*this.Vabs-this.Vmax)/(t-1)}},{key:"fitExp",value:function(){console.log("fitExp");var t=1+Math.pow(Math.E,-(this.lastPel-this.PidExp)/this.Kid);this.VmaxExp=this.Vmin+(this.Vabs-this.Vmin)*t}},{key:"fit",value:function(){0<this.flow&&this.lastFlow<0?this.fitInsp():this.flow<0&&0<this.lastFlow&&this.fitExp(),this.lastFlow=this.flow}},{key:"Pel",get:function(){if(this.fit(),0<=this.flow){var t=sv.sygX(this.Vabs,this.VminInsp,this.Vmax,this.PidInsp,this.Kid);return this.lastPel=t}t=sv.sygX(this.Vabs,this.Vmin,this.VmaxExp,this.PidExp,this.Kid);return this.lastPel=t}},{key:"PidInsp",get:function(){return this.Pid+this.Phister/2}},{key:"PidExp",get:function(){return this.Pid-this.Phister/2}}]),i}(),sv.Ventilator=function(){function t(){_classCallCheck(this,t),this.time=0,this.Tvent=12,this.Tsampl=.003,this.demoLung=sv.SimpleLung,this.simParams={Tsampl:{unit:"s"},Tvent:{uni:"s"}}}return _createClass(t,[{key:"updateCalcParams",value:function(){console.log("updateCalcParams is deprecated")}},{key:"ventilate",value:function(t){for(this.timeData=[],this.simulationStop=this.time+this.Tvent;this.time<=this.simulationStop;)this.ventilationCycle(t);if(1<this.lowPass)for(var i in this.dataToFilter)for(var s=this.dataToFilter[i],e=this.timeData[0][s],n=1,a=this.timeData.length;n<a;++n){e+=(this.timeData[n][s]-e)/this.lowPass,this.timeData[n][s]=e}if(2<=this.rAvg)for(var i in this.dataToFilter)sv.avg(this.timeData,this.dataToFilter[i],this.rAvg);return{timeData:this.timeData}}},{key:"ventilationCycle",value:function(){throw"ventilationCycle() must be implemented i high level ventilator model."}},{key:"sampleWaveform",value:function(){var t=new this.demoLung,i=this.ventilate(t).timeData,s=["Pao"];for(var e in s){var n=function(t){return t.time},a=function(t){return t[s[e]]},o="svg"+document.querySelectorAll("svg").length;document.write("<svg id='"+o+"' class='ventSample'></svg>");var r=new gs.graph("#"+o);r.setscale(i,n,a),r.tracer(i,n,a),r.setidx("Time (s)"),r.setidy(s[e])}}},{key:"defaultsTable",value:function(){sv.defaultsTable.call(this,this.ventParams)}}]),t}(),sv.PressureAssistor=function(t){function i(){_classCallCheck(this,i);var t=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return t.Passist=12,t.PEEP=5,t.Cycling=25,t.Ftrig=.1,t.demoLung=sv.SptLung,t.ventParams={Passist:{unit:"cmH₂O"},PEEP:{unit:"cmH₂O"},Ftrig:{unit:"l/min."},Cycling:{unit:"%"}},t}return _inherits(i,sv.Ventilator),_createClass(i,[{key:"ventilationCycle",value:function(t){for(this.Fmax=0,this.Pao=this.PEEP;t.flow<this.Ftrig&&this.time<=this.simulationStop;)t.appliquer_pression(this.PEEP,this.Tsampl),this.timeData.push(sv.log(t,this)),this.time+=this.Tsampl;for(this.Pao=this.Passist+this.PEEP;t.flow>this.Fstop&&this.time<=this.simulationStop;)t.appliquer_pression(this.Passist,this.Tsampl),this.timeData.push(sv.log(t,this)),this.time+=this.Tsampl,t.flow>this.Fmax&&(this.Fmax=t.flow);t.appliquer_pression(this.PEEP,this.Tsampl)}},{key:"Fstop",get:function(){return this.Fmax*this.Cycling/100}}]),i}(),sv.PressureControler=function(t){function i(){_classCallCheck(this,i);var t=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return t.Pinspi=10,t.PEEP=5,t.Ti=1,t.Fconv=12,t.ventParams={Pinspi:{unit:"cmH₂O"},PEEP:{unit:"cmH₂O"},Fconv:{unit:"/min."},Ti:{unit:"cmH₂O"},Te:{calculated:!0,unit:"sec."},Tcycle:{calculated:!0,unit:"sec."}},t}return _inherits(i,sv.Ventilator),_createClass(i,[{key:"ventilationCycle",value:function(t){this.time;var i=this.time+this.Ti;for(this.Pao=this.Pinspi+this.PEEP;this.time<i&&this.time<=this.simulationStop;)t.appliquer_pression(this.Pao,this.Tsampl),this.timeData.push(sv.log(t,this)),this.time+=this.Tsampl;i=this.time+this.Te;for(this.Pao=this.PEEP;this.time<i&&this.time<=this.simulationStop;)t.appliquer_pression(this.Pao,this.Tsampl),this.timeData.push(sv.log(t,this)),this.time+=this.Tsampl}},{key:"Tcycle",get:function(){return 60/this.Fconv}},{key:"Te",get:function(){return this.Tcycle-this.Ti}}]),i}(),sv.PVCurve=function(t){function i(){_classCallCheck(this,i);var t=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return t.Pstart=0,t.Pmax=100,t.Pstop=0,t.Pstep=2,t.Tman=20,t.ventParams={Pstart:{unit:"cmH₂O"},Pmax:{unit:"cmH₂O"},Pstop:{unit:"cmH₂O"},Pstep:{unit:"cmH₂O"},Tman:{unit:"s"}},t}return _inherits(i,sv.Ventilator),_createClass(i,[{key:"ventilate",value:function(t){var i=[];for(this.time=0,this.nbStep=(this.Pmax-this.Pstart+(this.Pmax-this.Pstop))/this.Pstep,this.Ti=this.Tman/this.nbStep,this.Pao=this.Pstart;this.Pao<this.Pmax;){for(var s=this.time;this.time<s+this.Ti;)t.appliquer_pression(this.Pao,this.Tsampl),i.push(sv.log(t,this)),this.time+=this.Tsampl;this.Pao+=this.Pstep}for(;this.Pao>=this.Pstop;){for(s=this.time;this.time<s+this.Ti;)t.appliquer_pression(this.Pao,this.Tsampl),i.push(sv.log(t,this)),this.time+=this.Tsampl;this.Pao-=this.Pstep}return{timeData:i,respd:[]}}}]),i}(),sv.Phasitron={},sv.Phasitron.Fop=function(t,i){return 0<=i&&i<=40?t+t*(5-i/8):40<i?t:i<0?6*t:void 0},sv.VDR=function(t){function i(){_classCallCheck(this,i);var t=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return t.Tramp=.005,t.Rexp=1,t.rAvg=2,t.lowPass=3,t.simParams={Tvent:{unit:"s"},Tsampl:{unit:"s"},Tramp:{unit:"s"},Rexp:{unit:"cmH₂O/l/s"},rAvg:{},lowPass:{}},t.Tic=2,t.Tec=2,t.Fperc=500,t.Rit=.5,t.Fipl=.18,t.Fiph=1.8,t.CPR=0,t.Fop=0,t.Fip=0,t.Pao=0,t.CycleC=0,t.ventParams={Tic:{unit:"s"},Tec:{unit:"s"},Fconv:{unit:"s",calculated:!0},Fperc:{unit:"/min"},Fhz:{unit:"hz",calculated:!0},Rit:{},Fiph:{unit:"l/s"},Fipl:{unit:"l/s"},CPR:{}},t.dataToFilter=["Pao","Flung"],t}return _inherits(i,sv.Ventilator),_createClass(i,[{key:"percussiveExpiration",value:function(t,i){t.flow=0,this.Fip=0,this.Fop=0,this.stateP=0,t.Vtep=0;for(var s=this.time+this.Tep;this.time<s;){this.Pao=-t.flow*i;var e=(this.Pao-t.Palv)/t.Raw;t.appliquer_debit(e,this.Tsampl),this.timeData.push(sv.log(t,this)),this.time+=this.Tsampl}}},{key:"percussiveInspiration",value:function(t,i){this.stateP=1,t.Vtip=0,this.Fip=i;this.time;for(var s=this.time+this.Tip;this.time<s;)this.Fip=i,this.Pao=this.Fop*t.Raw+t.Palv,this.Fop=sv.Phasitron.Fop(this.Fip,this.Pao),t.appliquer_debit(this.Fop,this.Tsampl),this.timeData.push(sv.log(t,this)),this.time+=this.Tsampl}},{key:"convectiveInspiration",value:function(t){var i=this.Tcc*Math.ceil(this.time/this.Tcc),s=this.time+.8;for(this.CycleC=1;this.time<i&&this.time<this.simulationStop;){if(this.time<s)var e=this.Fiph;else e=this.Fiph*(1+this.CPR);this.percussiveInspiration(t,e),this.time<s?this.percussiveExpiration(t,this.Rexp):this.percussiveExpiration(t,this.Rexp*(1+this.CPR))}}},{key:"convectiveExpiration",value:function(t){var i=this.Tcc*Math.floor(this.time/this.Tcc)+this.Tec;for(this.CycleC=0;this.time<i&&this.time<this.simulationStop;)this.percussiveInspiration(t,this.Fipl),this.percussiveExpiration(t,this.Rexp)}},{key:"ventilationCycle",value:function(t){this.convectiveExpiration(t),this.convectiveInspiration(t)}},{key:"Fhz",get:function(){return this.Fperc/60}},{key:"Fconv",get:function(){return 60/(this.Tic+this.Tec)}},{key:"Tcc",get:function(){return this.Tic+this.Tec}},{key:"Tip",get:function(){return 60/this.Fperc*this.Rit}},{key:"Tep",get:function(){return 60/this.Fperc-this.Tip}}]),i}(),sv.FlowControler=function(t){function i(){_classCallCheck(this,i);var t=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return t.Vt=.5,t.PEEP=5,t.Ti=1,t.Fconv=12,t.ventParams={Vt:{unit:"l"},PEEP:{unit:"cmH₂O"},Fconv:{unit:"/min."},Ti:{unit:"cmH₂O"},Te:{calculated:!0,unit:"sec."},Tcycle:{calculated:!0,unit:"sec."}},t}return _inherits(i,sv.Ventilator),_createClass(i,[{key:"Aventilate",value:function(t){var i=[],s=[];for(this.time=0;this.time<this.Tvent;){for(var e=this.time;this.time<e+this.Ti;)t.appliquer_debit(this.Flow,this.Tsampl),this.Pao=t.Palv+this.Flow*t.Raw,i.push(sv.log(t,this)),this.time+=this.Tsampl;for(this.Pao=this.PEEP;this.time<e+60/this.Fconv;)t.appliquer_pression(this.Pao,this.Tsampl),i.push(sv.log(t,this)),this.time+=this.Tsampl;var n=713*t.veco2/t.vce;s.push({pmeco2:n,petco2:t.pco2,pAco2:t.PACO2,fowler:t.Vem/t.vce,bohr:(t.PACO2-n)/t.PACO2})}return{timeData:i,convData:s}}},{key:"ventilationCycle",value:function(t){for(var i=this.time+this.Ti;this.time<i&&this.time<=this.simulationStop;this.time+=this.Tsampl)t.appliquer_debit(this.Flow,this.Tsampl),this.Pao=t.Palv+this.Flow*t.Raw,this.timeData.push(sv.log(t,this));this.Pao=this.PEEP;for(i=this.time+this.Te;this.time<i&&this.time<=this.simulationStop;this.time+=this.Tsampl)t.appliquer_pression(this.Pao,this.Tsampl),this.timeData.push(sv.log(t,this))}},{key:"Tcycle",get:function(){return 60/this.Fconv}},{key:"Te",get:function(){return 60/this.Fconv-this.Ti}},{key:"Flow",get:function(){return this.Vt/this.Ti}}]),i}(),sv.Protocol=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"ventilate",value:function(t){}}]),t}(),sv.ventilators=[sv.PressureControler,sv.FlowControler,sv.PressureAssistor,sv.VDR,sv.PVCurve],sv.lungs=[sv.SimpleLung,sv.SptLung,sv.SygLung,sv.RLung];