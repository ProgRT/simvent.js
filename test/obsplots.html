<!DOCTYPE html>
<meta charset="utf-8"/>

<style>
body {
	box-sizing: border-box;
	padding: none;
	margin-top: none;
}

html {
	box-sizing: border-box;
	height: 100%;
	padding: 0px;
	margin: 0px;
}

</style>

<body>

<script type=module>

	import {FlowControler} from '../src/simvent-ventilators.js';
	import {SimpleLung} from '../src/simvent-lungs.js';
	import {plot, line, lineY, dot, areaY, axisY, ruleX, text} from "https://cdn.skypack.dev/@observablehq/plot@0.6";

    function getPhase2(data){
        data = data.map((d,i,a)=>{
            d.dCO2 = i == 0 ? 0 : d.PCO2 - a[i-1].PCO2;
            d.dVte = i == 0 ? 0 : d.Vte - a[i-1].Vte;
            d.slCO2 = d.dCO2 != 0 && d.dVte != 0 ? d.dCO2/d.dVte : 0 ;
            return d;
        });

        let maxSlope = Math.max(...data.map(d=>d.slCO2));

        data = data.map(d=>{
            d.slCO2 = d.slCO2/maxSlope;
            return d;
        });

        return data.filter(d=>d.slCO2 > 0.1);
    }

    function vCapLabels(data){
        let phase2 = getPhase2(data);
        let sl = phase2.map(d=>d.slCO2);
        let slMax = Math.max(...sl);
        let VdawPos = sl.indexOf(slMax);
        let Vdaw = phase2[VdawPos].Vte;

        let x0 = data[0].Vte;
        let x1 = phase2[0].Vte;
        let x2 = phase2[phase2.length - 1].Vte;
        let xmax = data[data.length - 1].Vte;

        let xI = x0 + 0.5 * (x1 - x0);
        let xII = Vdaw;
        let xIII = x2 + 0.5 * (xmax - x2);

        let EtCO2 = Math.max(...data.map(d=>d.PCO2));

        return [
            [xI, 2.5],
            [xII, phase2[VdawPos].PCO2],
            [xIII, EtCO2 - 5]
        ];
    }

    const conf = {
        labText: (d, i) => `Phase ${"I".repeat(i+1)}`,
        mksConf: {
            fontSize: 16,
            fontWeight: "bold",
            stroke: "white",
            fill: "black"
        }
    }

    function vCapnogram(data, {mksConf, labText}=conf){

        let labels = vCapLabels(data);

        return plot({
            width: document.documentElement.clientWidth,
            height: document.documentElement.clientWidth/2,
            grid: true,
            marks: [
                line(data, {x: "Vte", y: "PCO2"}),
                text(labels, {x: "0", y: "1", text: labText, ...mksConf}),
                ]
        });
    }

    var vent = new FlowControler({Tlow: 0.8, Tvent: 5, PEEP: 0});
    var lung = new SimpleLung({
        PACO2: 40,
        Vdaw: 0.150,
        Slope2: .02,
        Slope3: 20
    });
    var data = vent.ventilate(lung).timeData;

    document.body.append(vCapnogram(data));

</script>
</body>
